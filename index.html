<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="./assets/styles/normalize.css"/>
    <link rel="stylesheet" href="./assets/styles/styles.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/intl-tel-input@23.1.0/build/css/intlTelInput.css">
    <script src="https://cdn.jsdelivr.net/npm/intl-tel-input@23.1.0/build/js/intlTelInput.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
          integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
          crossorigin="anonymous" referrerpolicy="no-referrer"/>
</head>
<body>
<div class="page">
    <main class="main">
        <form action="" class="form" id="jobForm">
            <div class="row row--center">
                <!-- Client details -->
                <div class="card card__client-details">
                    <div class="card__content">
                        <h2 class="card__headline">Client details</h2>
                        <div class="row mb">
                            <div class="card__firstName card__field">
                                <div class="input-field input-field--layout">
                                    <input class="input-field__input field field--hover card__firstName-input"
                                           placeholder="First name" type="text"
                                           name="first_name" id="first_name" required/>
                                </div>
                            </div>

                            <div class="card__lastName card__field">
                                <div class="input-field input-field--layout">
                                    <input class="input-field__input field field--hover card__lastName-input"
                                           placeholder="Last name" type="text"
                                           name="last_name" id="last_name" required/>
                                </div>
                            </div>
                        </div>
                        <div class="card__phone card__field mb">
                            <div class="input-field input-field--layout">
                                <input class="input-field__input field field--hover card__phone-input"
                                       placeholder="Phone" type="tel"
                                       name="phone" id="phone" required/>
                            </div>
                        </div>
                        <div class="card__email card__field">
                            <div class="input-field input-field--layout">
                                <input class="input-field__input field field--hover card__email-input"
                                       placeholder="Email (optional)" type="email"
                                       name="email" id="email"/>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- end -->

                <!-- Job details -->
                <div class="card card__job-details">
                    <div class="card__content">
                        <h2 class="card__headline">Job details</h2>
                        <div class="row mb">
                            <div class="card__job card__field field-wrapper">
                                <div class="select-field select-field--layout">
                                    <select name="job_type" required class="select-field__select field card__job-select"
                                            id="job_type">
                                        <option value="" disabled selected>Job type</option>
                                        <option value="test">Job</option>
                                    </select>
                                    <label for="job_type">
                                        <div class="icon icon--end">
                                            <div class="divider divider--vertical"></div>
                                            <i class="fa-solid fa-arrow-down"></i>
                                        </div>
                                    </label>
                                </div>
                            </div>

                            <div class="card__job-source card-field field-wrapper">
                                <div class="select-field select-field--layout">
                                    <select name="job_source" required
                                            class="select-field__select field card__job-source-select" id="job_source">
                                        <option value="" disabled selected>Job source</option>
                                        <option value="job_source">Source example</option>
                                    </select>
                                    <label for="job_source">
                                        <div class="icon icon--end">
                                            <div class="divider divider--vertical"></div>
                                            <i class="fa-solid fa-arrow-down"></i>
                                        </div>
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="card__job-description full-height card-field">
                            <div class="input-field full-height input-field--layout">
                                    <textarea
                                            class="input-field__input full-height field field--hover card__job-description-textarea"
                                            placeholder="Job (optional)"
                                            name="job_description" id="job"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- end -->
            </div>
            <div class="row row--center">
                <!-- Service location -->
                <div class="card card__service-location">
                    <div class="card__content">
                        <h2 class="card__headline">Service location</h2>
                        <div class="card__address">
                            <div class="input-field input-field--layout">
                                <input class="input-field__input field field--hover card__address-input"
                                       placeholder="Address" type="text"
                                       name="address" id="address" required/>
                            </div>
                        </div>

                        <div class="card__city">
                            <div class="input-field input-field--layout">
                                <input class="input-field__input field field--hover card__city-input"
                                       placeholder="City" type="text"
                                       name="city" id="city" required/>
                            </div>
                        </div>

                        <div class="card__state">
                            <div class="input-field input-field--layout">
                                <input class="input-field__input field field--hover card__state-input"
                                       placeholder="State" type="text"
                                       name="state" id="state" required/>
                            </div>
                        </div>

                        <div class="row">
                            <div class="card__zip">
                                <div class="input-field input-field--layout">
                                    <input class="input-field__input field field--hover card__zip-input"
                                           placeholder="Zip" type="text"
                                           name="zip" id="zip" pattern="\d{5}" title="Zip code should be 5 digits"
                                           required/>
                                </div>
                            </div>
                            <div class="card__area field-wrapper">
                                <div class="select-field select-field--layout">
                                    <select name="area" required class="select-field__select field card__area-select"
                                            id="area">
                                        <option value="" disabled selected>Area</option>
                                        <option value="Area example">Area example</option>
                                    </select>
                                    <label for="area">
                                        <div class="icon icon--end">
                                            <div class="divider divider--vertical"></div>
                                            <i class="fa-solid fa-arrow-down"></i>
                                        </div>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- end -->

                <!-- Schedule -->
                <div class="card">
                    <div class="card__content">
                        <h2 class="card__headline">Scheduled</h2>
                        <div class="card__date field-wrapper">
                            <div class="select-field select-field--layout">
                                <input class="input-field__input field field--hover card__date-input"
                                       placeholder="DD/MM/YYYY" type="date"
                                       name="date" id="date" required/>
                                <label for="date">
                                    <div class="icon icon--end">
                                        <i class="fa-regular fa-calendar"></i>
                                    </div>
                                </label>
                            </div>
                        </div>
                        <div class="row">
                            <div class="card__start field-wrapper">
                                <div class="select-field select-field--layout">
                                    <input class="input-field__input field input__time field--hover card__start-input"
                                           placeholder="Start time" type="text"
                                           name="start_date" id="start_date" required/>
                                    <label for="start_date">
                                        <div class="icon icon--end">
                                            <i class="fa-regular fa-clock"></i>
                                        </div>
                                    </label>
                                </div>
                            </div>

                            <div class="card__end field-wrapper">
                                <div class="select-field select-field--layout">
                                    <input class="input-field__input field input__time field--hover card__end-input"
                                           placeholder="End time" type="text"
                                           name="end_date" id="end_date" required/>
                                    <label for="end_date">
                                        <div class="icon icon--end">
                                            <i class="fa-regular fa-clock"></i>
                                        </div>
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="card__test field-wrapper">
                            <div class="select-field select-field--layout">
                                <select name="technician" required class="select-field__select field card__test-select"
                                        id="technician">
                                    <option value="" disabled selected>Select technician</option>
                                    <option value="technician">technician</option>
                                </select>
                                <label for="technician">
                                    <div class="icon icon--end">
                                        <div class="divider divider--vertical"></div>
                                        <i class="fa-solid fa-arrow-down"></i>
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- end -->
            </div>
            <div class="row row--center form__actions">
                <button class="btn form__actions-submit btn--rounded btn--primary" type="submit">
                    Create job
                </button>
                <button class="btn form__actions-save btn--rounded btn--secondary" type="button">
                    Save info
                </button>
            </div>
        </form>
        <div class="main__process none">
            <div class="process-information">
                <h2 class="process-information__headline">
                    Job is created!
                </h2>
                <p class="process-information__text">View Deal</p>
                <a href="#" class="process-information__link">View in Workiz</a>
            </div>
        </div>
    </main>
</div>


<script>
    document.addEventListener("DOMContentLoaded", () => {
        var fields;
        var saveInfoButton = document.querySelector(".form__actions-save")
        var phoneInputField;
        var token;
        var phoneInput;
        var form;
        initialize()


        function changeTypeTimeToInput() {
            console.log("here")
            const inputsTime = Array.from(document.querySelectorAll(".input__time"))
            for (let i = 0; i < inputsTime.length; i++) {
                console.log(inputsTime[i])
                inputsTime[i].addEventListener("focus", function (e) {
                    console.log(e.target)
                    if (e.target.type == "time") {
                        e.target.type = "text"
                    } else {
                        e.target.type = "time"
                    }
                })
                inputsTime[i].addEventListener("blur", function (e) {
                    if (e.target.type == "time") {
                        e.target.type = "text"
                    } else {
                        e.target.type = "time"
                    }
                })
            }
        }

        function initialize() {
            fields = {
                first_name: "6a9bc164e79dbe94e3b4b5f8ef0c19a454b17772",
                technician: "e924c8d0f4933afd49a1d1534519a52543d27356",
                last_name: "4aa8c5415efd12c1664c30d4b9830d82f54a6cb7",
                phone: "09ff1b88a145cffb658d8d089a803fe3348c2c82",
                email: "b0e1ec2818d249aba2782dd4d9b902b363650edf",
                job_type: "e1a773113f27266cb46058c81347848c64d1e0e8",
                job_source: "eeeade7397d8656637681a7c3af3881d0c83a174",
                job_description: "9a38c46507f2c304d9a6a732274c01e9645c63fe",
                address: "0a5ea33e3df3bdb80a839bcea798fea2243d1d71",
                city: "fade4bd7cc322ec868667212a8190224f99d4a48",
                state: "4583b542cdcc9edbe63f62ac31deb4502be4cfa7",
                zip: "3d83193c378073135a1618a1aac1322c7140dad2",
                area: "526ef95c0ac4bb92edb719775a59e97f481347a4",
                date: "6a726f7ac7aa01315c2d8d571db7acaf19bf87e3",
                start_date: "b4443e35b72d50620f2332ecbae427864fb11063",
                end_date: "c43b12b33aa84d881b7dcd694edef574ac2d0ab4"
            }
            saveInfoButton = document.querySelector(".form__actions-save")
            phoneInputField = document.querySelector("#phone");
            token = "90e878d72b4ee6bbbfd69644090585b950f196e0";
            phoneInput = window.intlTelInput(phoneInputField, {
                utilsScript: "https://cdn.jsdelivr.net/npm/intl-tel-input@23.1.0/build/js/utils.js",
            });
            form = document.querySelector(".form");
            form.addEventListener('submit', handleSubmit);
            saveInfoButton.addEventListener("click", saveInfo)
            insertFormFromLocalStorage();
            changeTypeTimeToInput()
        }

        function handleSubmit(event) {
            event.preventDefault();

            clearErrors();

            if (isFormValid()) {
                const data = getFormData();
                document.querySelector(".form__actions-submit").classList.remove("btn--primary")
                document.querySelector(".form__actions-submit").classList.toggle("btn--info")
                document.querySelector(".form__actions-submit").innerText = "Request is sent"
                submitData(data.data).then((result) => {
                    document.querySelector(".form").classList.add("none")
                    document.querySelector(".main__process").classList.remove("none")
                });
            } else {
                alert('form is not completed');
            }
        }


        function saveInfo() {
            console.log("click")
            const data = getFormData().parsedData
            data["countryPhone"] = phoneInput.getSelectedCountryData()
            localStorage.setItem('formData', JSON.stringify(data));
        }

        function clearErrors() {
            document.querySelectorAll('.field').forEach(field => {
                field.classList.remove('field--error');
            });
        }

        function isFormValid() {
            let valid = true;

            document.querySelectorAll('.field[required]').forEach(field => {
                if (!field.value.trim()) {
                    field.classList.add('field--error');
                    valid = false;
                }
            });

            if (!phoneInput.isValidNumber()) {
                document.getElementById('phone').classList.add('field--error');
                valid = false;
            }

            return valid;
        }

        function getFormData() {
            const formData = new FormData(form);
            const parsedData = {}
            const data = {};
            formData.forEach((value, key) => {
                parsedData[key] = value
                data[fields[key]] = value;
            });
            data["title"] = "Workiz title"
            return {parsedData, data}
        }

        async function submitData(data) {
            try {
                await new Promise(r => setTimeout(r, 2000));
                const response = await fetch(`https://api.pipedrive.com/v1/deals?api_token=${token}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                const result = await response.json();

                if (result.success) {
                    alert('success');
                } else {
                    alert('error: ' + result.error);
                }
            } catch (error) {
                alert('error also: ' + error.message);
            }
        }

        function insertFormFromLocalStorage() {
            const savedData = localStorage.getItem('formData');
            if (savedData) {
                phoneInput.setCountry(JSON.parse(savedData).countryPhone.iso2)
                const parsedData = JSON.parse(savedData);
                console.log(parsedData)
                Object.keys(fields).forEach(key => {
                    console.log(parsedData[key], key)
                    const value = parsedData[key];
                    if (value !== undefined) {
                        const inputField = document.querySelector(`[name="${key}"]`);
                        if (inputField) {
                            inputField.value = value;
                        }
                    }
                });
            }
        }
    });
</script>
</body>
</html>